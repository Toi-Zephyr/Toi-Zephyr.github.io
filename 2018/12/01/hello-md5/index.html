<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Zephyr"><title>MD5 算法的设计与实现 · 迷楼</title><meta name="description" content="实现一个 MD5 算法算法原理概述什么是 MD5 ？MD5 算法是一种消息摘要算法。特点：

定长性。输入任意长度的信息，经过处理，输出为128位的信息。
唯一性。不同的输入得到的不同的结果。
不可逆。根据128位的输出结果不可能反推出输入的信息。

实现原理MD5 算法可以简单概括成4步。

信息"><meta name="keywords" content="blog"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">後は野となれ山となれ</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">見ぬが花</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">首頁</a></li><li><a href="/archives">歸檔</a></li><li><a href="/categories">分類</a></li><li><a href="/tags">標籤</a></li><li><a href="/404.html">404</a></li><li><a href="/about/index.html">關於</a></li><li class="soc"><a href="https://github.com/Zophyr" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2019&nbsp;<a target="_blank" href="http://zophyr.com" rel="noopener noreferrer">Zephyr</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>MD5 算法的设计与实现</a></p><p class="post-meta"><span class="date meta-item">發佈於&nbsp;2018-12-01</span><span class="meta-item"><i class="fa fa-folder"></i><span>&nbsp;</span><a href="/categories/教程/" title="教程" class="a-tag">教程</a><span>&nbsp;</span></span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/教程/" title="教程" class="a-tag">教程</a><span> / </span><a href="/tags/hello-world/" title="hello-world" class="a-tag">hello-world</a><span> / </span><a href="/tags/算法/" title="算法" class="a-tag">算法</a><span> / </span><a href="/tags/MD5/" title="MD5" class="a-tag">MD5</a><span> / </span><a href="/tags/加密/" title="加密" class="a-tag">加密</a><span> / </span></span></p><p class="post-abstract"></p><h1 id="实现一个-MD5-算法"><a href="#实现一个-MD5-算法" class="headerlink" title="实现一个 MD5 算法"></a>实现一个 MD5 算法</h1><h2 id="算法原理概述"><a href="#算法原理概述" class="headerlink" title="算法原理概述"></a>算法原理概述</h2><h3 id="什么是-MD5-？"><a href="#什么是-MD5-？" class="headerlink" title="什么是 MD5 ？"></a>什么是 MD5 ？</h3><p>MD5 算法是一种消息摘要算法。<br>特点：</p>
<ol>
<li>定长性。输入任意长度的信息，经过处理，输出为128位的信息。</li>
<li>唯一性。不同的输入得到的不同的结果。</li>
<li>不可逆。根据128位的输出结果不可能反推出输入的信息。</li>
</ol>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p><strong>MD5 算法可以简单概括成4步。</strong></p>
<ol>
<li><strong>信息填充。</strong>MD5 对于处理信息的字节长度有要求——输入信息的长度(bit)对512求余的结果等于448——所以我们要先对输入的数据进行处理，使其长度符合算法要求。</li>
<li><strong>记录信息长度。</strong>MD5 中会用64位来存储信息长度。这样加上第一步中的长度。总的数据长度就为 <code>N x 512</code> 为512的倍数。</li>
<li><strong>四轮循环运算。</strong>这是 MD5 算法的核心。我们直接根据算法定义实现就好，可以简单理解为我们进行了一系列的非线性函数运算，计算出了MD5中四个32位的称作链接变量（Chaining Variable）的整数参数的新的值。</li>
<li><strong>合并链接变量。</strong>我们计算出新的四个链接变量值后，我们按照逆序，将他们转化成16进制的数然后四个合在一起。最终，我们将得到的结果输出。</li>
</ol>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="数据定义"><a href="#数据定义" class="headerlink" title="数据定义"></a>数据定义</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * byte 字节</span></span><br><span class="line"><span class="comment"> * 一个字符(char) 即 一个字节(byte) 8位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> byte;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bit 比特</span></span><br><span class="line"><span class="comment"> * 无符号整数 即 32位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> bit32;</span><br></pre></td></tr></table></figure>
<h3 id="公有函数"><a href="#公有函数" class="headerlink" title="公有函数"></a>公有函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 构造函数，用于初始化 MD5 算法。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MD5(<span class="keyword">const</span> <span class="built_in">string</span> &amp;message);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 获得经过 MD5 算法之后的结果。</span></span><br><span class="line"><span class="comment"> * 在此处完成合并链接变量。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">getResult</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="私有函数"><a href="#私有函数" class="headerlink" title="私有函数"></a>私有函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 初始化函数</span></span><br><span class="line"><span class="comment"> * 进行 Step 1.信息填充</span></span><br><span class="line"><span class="comment"> * 同时也会进行 Step 2.记录信息长度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> _init(<span class="keyword">const</span> <span class="built_in">string</span> input);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 循环分组函数</span></span><br><span class="line"><span class="comment"> * 为步骤3做准备</span></span><br><span class="line"><span class="comment"> * 将每一512字节细分成16个小组，每个小组64位以此来进行循环运算。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> _loop();</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * MD5 主变换循环</span></span><br><span class="line"><span class="comment"> * 进行 Step 3.四轮循环运算</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> _transform(<span class="keyword">const</span> bit32 block[]);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 转化函数</span></span><br><span class="line"><span class="comment"> * 按照逆序，将得到的四个链接变量转化成16进制</span></span><br><span class="line"><span class="comment"> * 进行 Step 4.合并链接变量的前一步。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">string</span> _toHex(<span class="keyword">const</span> bit32 number);</span><br></pre></td></tr></table></figure>
<h3 id="私有变量"><a href="#私有变量" class="headerlink" title="私有变量"></a>私有变量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * MD5 四个标准幻数 A, B, C, D</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">bit32 _state[<span class="number">4</span>];</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 处理之后数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">bit32 *_strByte;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 数据长度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">bit32 _strLength;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">string</span> _result;</span><br></pre></td></tr></table></figure>
<h2 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><h4 id="定义标准幻数"><a href="#定义标准幻数" class="headerlink" title="定义标准幻数"></a>定义标准幻数</h4><p>标准的幻数（物理顺序）是</p>
<ul>
<li>A=(01234567)16 </li>
<li>B=(89ABCDEF)16 </li>
<li>C=(FEDCBA98)16 </li>
<li>D=(76543210)16 </li>
</ul>
<p>如果在程序中定义应该是</p>
<ul>
<li>A=0X67452301</li>
<li>B=0XEFCDAB89</li>
<li>C=0X98BADCFE</li>
<li>D=0X10325476</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MD5 四个标准幻数 A, B, C, D</span></span><br><span class="line"><span class="comment"> * 由算法定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> A 0x67452301</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> B 0xefcdab89</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> C 0x98badcfe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> D 0x10325476</span></span><br></pre></td></tr></table></figure>
<h4 id="定义变换辅助函数"><a href="#定义变换辅助函数" class="headerlink" title="定义变换辅助函数"></a>定义变换辅助函数</h4><p>以下是每次操作中用到的四个非线性函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义 MD5 变换辅助函数</span></span><br><span class="line"><span class="comment"> * 由 MD5 算法本身定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> F(x, y, z) (((x) &amp; (y)) | ((~x) &amp; (z)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> G(x, y, z) (((x) &amp; (z)) | ((y) &amp; (~z)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> H(x, y, z) ((x) ^ (y) ^ (z))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> I(x, y, z) ((y) ^ ((x) | (~z)))</span></span><br></pre></td></tr></table></figure>
<h4 id="定义四种基本变换"><a href="#定义四种基本变换" class="headerlink" title="定义四种基本变换"></a>定义四种基本变换</h4><p>以下是 MD5 算法中的四种基本变换</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MD5 四种基本变换</span></span><br><span class="line"><span class="comment"> * 由 MD5 算法本身定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF(a, b, c, d, x, s, ac) &#123; \</span></span><br><span class="line">    (a) += F ((b), (c), (d)) + (x) + ac; \</span><br><span class="line">    (a) = ROTATELEFT ((a), (s)); \</span><br><span class="line">    (a) += (b); \</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GG(a, b, c, d, x, s, ac) &#123; \</span></span><br><span class="line">    (a) += G ((b), (c), (d)) + (x) + ac; \</span><br><span class="line">    (a) = ROTATELEFT ((a), (s)); \</span><br><span class="line">    (a) += (b); \</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HH(a, b, c, d, x, s, ac) &#123; \</span></span><br><span class="line">    (a) += H ((b), (c), (d)) + (x) + ac; \</span><br><span class="line">    (a) = ROTATELEFT ((a), (s)); \</span><br><span class="line">    (a) += (b); \</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> II(a, b, c, d, x, s, ac) &#123; \</span></span><br><span class="line">    (a) += I ((b), (c), (d)) + (x) + ac; \</span><br><span class="line">    (a) = ROTATELEFT ((a), (s)); \</span><br><span class="line">    (a) += (b); \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MD5::MD5(<span class="keyword">const</span> <span class="built_in">string</span> &amp;message) &#123;</span><br><span class="line">    <span class="comment">// 初始化标准幻数</span></span><br><span class="line">    _state[<span class="number">0</span>] = A;</span><br><span class="line">    _state[<span class="number">1</span>] = B;</span><br><span class="line">    _state[<span class="number">2</span>] = C;</span><br><span class="line">    _state[<span class="number">3</span>] = D;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化私有变量</span></span><br><span class="line">    _result = <span class="string">""</span>;</span><br><span class="line">    _strByte = <span class="literal">NULL</span>;</span><br><span class="line">    _strLength = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用填充函数</span></span><br><span class="line">    _init(message);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用循环分组函数</span></span><br><span class="line">    _loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Step-1-amp-2-信息填充与记录信息长度"><a href="#Step-1-amp-2-信息填充与记录信息长度" class="headerlink" title="Step 1&amp;2. 信息填充与记录信息长度"></a>Step 1&amp;2. 信息填充与记录信息长度</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MD5::_init(<span class="keyword">const</span> <span class="built_in">string</span> input) &#123;</span><br><span class="line">    bit32 blocks = (((bit32)input.length() + <span class="number">8</span>) / <span class="number">64</span>) + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    _strByte = <span class="keyword">new</span> bit32[blocks * <span class="number">16</span>];</span><br><span class="line">    _strLength = blocks * <span class="number">16</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 初始化 byte 串 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; _strLength; i++) &#123;</span><br><span class="line">        _strByte[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; input.length(); i++) &#123;</span><br><span class="line">        _strByte[i &gt;&gt; <span class="number">2</span>] |= input[i] &lt;&lt; ((i % <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _strByte[input.length() &gt;&gt; <span class="number">2</span>] |= (<span class="number">0x80</span> &lt;&lt; ((input.length() % <span class="number">4</span>) * <span class="number">8</span>));</span><br><span class="line">    </span><br><span class="line">    _strByte[blocks * <span class="number">16</span> - <span class="number">2</span>] = (bit32)input.size() * <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step-1-1"><a href="#Step-1-1" class="headerlink" title="Step 1.1"></a>Step 1.1</h4><p>我们首先需要对MD5进行分组。MD5 以512位来进行分组。我们输入的<code>input</code>是<code>char</code>也就是8位，所以每一个分组就会有 512 $\div$ 8 = 64个<code>char</code>字符。</p>
<p>又因为我们要在最后用64位来记录信息长度，所以也就是需要 64 $\div$ 8 = 8 个<code>char</code>字符。</p>
<p>所以，我们分块的时候，我们用 <code>input.length()</code> 得知输入多少个<code>char</code>字符，再加上固定的记录信息长度的8个字符，就是我们信息的总的长度。</p>
<p>然后我们就可以计算出我们需要有多少个分组。</p>
<p>👉 <code>bit32 blocks = (((bit32)input.length() + 8) / 64) + 1;</code></p>
<h4 id="Step-1-2"><a href="#Step-1-2" class="headerlink" title="Step 1.2"></a>Step 1.2</h4><p>接着，我们计算 <code>_strByte</code> 与 <code>_strLength</code>。</p>
<p>一个 <code>unsigned int</code> 有32位，所以我们用16个<code>int</code>就可以表达 32 x 16 = 512 位，也就是一个分组。</p>
<p>所以我们需要的存取数据的位数，同时初始化所有位数为0。</p>
<p>👉 <code>_strByte = new bit32[blocks * 16];</code></p>
<p>同时我们可以确认填充后的字符串的int的位数</p>
<p>👉 <code>_strLength = blocks * 16;</code></p>
<h4 id="Step-1-3"><a href="#Step-1-3" class="headerlink" title="Step 1.3"></a>Step 1.3</h4><p>一个 <code>char</code> 8位，一个 <code>unsigned int</code> 32位，所以一个 <code>unsigned int</code> 可以存4个 <code>char</code> 。</p>
<p>我们将输入的字符，存进去。通过</p>
<p>👉 <code>_strByte[i &gt;&gt; 2] |= input[i] &lt;&lt; ((i % 4) * 8);</code></p>
<ul>
<li><p>每个字符都有对应的 <strong>ASCII</strong> 码。</p>
</li>
<li><p><code>i &gt;&gt; 2</code> 代表的是 i / 4， 也就是找到字符所对应的 <code>_strByte</code> 位置。</p>
</li>
<li><p><code>(i % 4) * 8</code> 就是找到这个字符在 unsigned int 中所对应的字节。</p>
</li>
<li><p>| 操作可以理解为求和 比如 3 | 4 = 7</p>
</li>
</ul>
<p>举个例子，输入 abc</p>
<p>首先 i = 0, i &gt;&gt; 2 等于0 所以是 _strByte[0]。然后a对应的ASCII为97，((i % 4) * 8)等于0<br>所以整个式子为 _strByte[0] |= 97 &lt;&lt; 0 即 97</p>
<p>接着 i = 1, 1 &gt;&gt; 2 等于0 所以是 _strByte[0]，因为一个 uint 可以存 4个char 所以要等到第五个字符输入的时候，也就是 5 &gt;&gt; 2 等于 1 才会移动到下一位来存储字符。后面((i % 4) * 8) 等于 8 。因为一个char8位，所以第二个字符存进来的时候要左移八位，存到它应该在的地方。<br>所以整个式子为 _strByte[0] |= 98 &lt;&lt; 8 即 25088 | 97 等于 25158</p>
<p>以此类推，将输入存到 _strByte 中。</p>
<h4 id="Step-1-4"><a href="#Step-1-4" class="headerlink" title="Step 1.4"></a>Step 1.4</h4><p>填充 100000…<br>在字符都转化存入 _strByte 后我们要在剩下的位置第一个填充 1 其他填充 0<br>又因为我们初始化 _strByte 为全0，所以我们只用确定填充 1 在哪里就好了。</p>
<p>👉 <code>_strByte[input.length() &gt;&gt; 2] |= (0x80 &lt;&lt; ((input.length() % 4) * 8));</code></p>
<p>其中0x80是二进制的10000000，我们可以理解为在原来字符串的后面接上一个10000000<br>具体含义可以参考 Step 1.3 中的解释。</p>
<h4 id="Step-1-5"><a href="#Step-1-5" class="headerlink" title="Step 1.5"></a>Step 1.5</h4><p>记录字符长度。长度指位的长度，所以要乘8，同时MD5算法使用的是小端序，所以放在倒数第二个。</p>
<p>👉 <code>_strByte[blocks * 16 - 2] = (bit32)input.size() * 8;</code></p>
<h3 id="Step-3-四轮循环运算"><a href="#Step-3-四轮循环运算" class="headerlink" title="Step 3. 四轮循环运算"></a>Step 3. 四轮循环运算</h3><h4 id="前期准备-1"><a href="#前期准备-1" class="headerlink" title="前期准备"></a>前期准备</h4><p>分组函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MD5::_loop() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; _strLength / <span class="number">16</span>; i++) &#123;</span><br><span class="line">        bit32 group[<span class="number">16</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) &#123;</span><br><span class="line">            group[j] = _strByte[i * <span class="number">16</span> + j];</span><br><span class="line">        &#125;</span><br><span class="line">        _transform(group);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>首先是按照512 bits来分组，即16个int</li>
<li>然后每一分组被划分为16个32位int的子分组</li>
</ol>
<p>之后就可以进行 _transform(group);</p>
<h4 id="主变换循环"><a href="#主变换循环" class="headerlink" title="主变换循环"></a>主变换循环</h4><p>MD5 算法定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> MD5::_transform(<span class="keyword">const</span> bit32 block[]) &#123;</span><br><span class="line">    bit32 a = _state[<span class="number">0</span>], b = _state[<span class="number">1</span>], c = _state[<span class="number">2</span>], d = _state[<span class="number">3</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Round 1 */</span></span><br><span class="line">    FF (a, b, c, d, block[<span class="number">0</span>], s11, <span class="number">0xd76aa478</span>);</span><br><span class="line">    FF (d, a, b, c, block[<span class="number">1</span>], s12, <span class="number">0xe8c7b756</span>);</span><br><span class="line">    FF (c, d, a, b, block[<span class="number">2</span>], s13, <span class="number">0x242070db</span>);</span><br><span class="line">    FF (b, c, d, a, block[<span class="number">3</span>], s14, <span class="number">0xc1bdceee</span>);</span><br><span class="line">    FF (a, b, c, d, block[<span class="number">4</span>], s11, <span class="number">0xf57c0faf</span>);</span><br><span class="line">    FF (d, a, b, c, block[<span class="number">5</span>], s12, <span class="number">0x4787c62a</span>);</span><br><span class="line">    FF (c, d, a, b, block[<span class="number">6</span>], s13, <span class="number">0xa8304613</span>);</span><br><span class="line">    FF (b, c, d, a, block[<span class="number">7</span>], s14, <span class="number">0xfd469501</span>);</span><br><span class="line">    FF (a, b, c, d, block[<span class="number">8</span>], s11, <span class="number">0x698098d8</span>);</span><br><span class="line">    FF (d, a, b, c, block[<span class="number">9</span>], s12, <span class="number">0x8b44f7af</span>);</span><br><span class="line">    FF (c, d, a, b, block[<span class="number">10</span>], s13, <span class="number">0xffff5bb1</span>);</span><br><span class="line">    FF (b, c, d, a, block[<span class="number">11</span>], s14, <span class="number">0x895cd7be</span>);</span><br><span class="line">    FF (a, b, c, d, block[<span class="number">12</span>], s11, <span class="number">0x6b901122</span>);</span><br><span class="line">    FF (d, a, b, c, block[<span class="number">13</span>], s12, <span class="number">0xfd987193</span>);</span><br><span class="line">    FF (c, d, a, b, block[<span class="number">14</span>], s13, <span class="number">0xa679438e</span>);</span><br><span class="line">    FF (b, c, d, a, block[<span class="number">15</span>], s14, <span class="number">0x49b40821</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Round 2 */</span></span><br><span class="line">    GG (a, b, c, d, block[ <span class="number">1</span>], s21, <span class="number">0xf61e2562</span>);</span><br><span class="line">    GG (d, a, b, c, block[ <span class="number">6</span>], s22, <span class="number">0xc040b340</span>);</span><br><span class="line">    GG (c, d, a, b, block[<span class="number">11</span>], s23, <span class="number">0x265e5a51</span>);</span><br><span class="line">    GG (b, c, d, a, block[ <span class="number">0</span>], s24, <span class="number">0xe9b6c7aa</span>);</span><br><span class="line">    GG (a, b, c, d, block[ <span class="number">5</span>], s21, <span class="number">0xd62f105d</span>);</span><br><span class="line">    GG (d, a, b, c, block[<span class="number">10</span>], s22,  <span class="number">0x2441453</span>);</span><br><span class="line">    GG (c, d, a, b, block[<span class="number">15</span>], s23, <span class="number">0xd8a1e681</span>);</span><br><span class="line">    GG (b, c, d, a, block[ <span class="number">4</span>], s24, <span class="number">0xe7d3fbc8</span>);</span><br><span class="line">    GG (a, b, c, d, block[ <span class="number">9</span>], s21, <span class="number">0x21e1cde6</span>);</span><br><span class="line">    GG (d, a, b, c, block[<span class="number">14</span>], s22, <span class="number">0xc33707d6</span>);</span><br><span class="line">    GG (c, d, a, b, block[ <span class="number">3</span>], s23, <span class="number">0xf4d50d87</span>);</span><br><span class="line">    GG (b, c, d, a, block[ <span class="number">8</span>], s24, <span class="number">0x455a14ed</span>);</span><br><span class="line">    GG (a, b, c, d, block[<span class="number">13</span>], s21, <span class="number">0xa9e3e905</span>);</span><br><span class="line">    GG (d, a, b, c, block[ <span class="number">2</span>], s22, <span class="number">0xfcefa3f8</span>);</span><br><span class="line">    GG (c, d, a, b, block[ <span class="number">7</span>], s23, <span class="number">0x676f02d9</span>);</span><br><span class="line">    GG (b, c, d, a, block[<span class="number">12</span>], s24, <span class="number">0x8d2a4c8a</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Round 3 */</span></span><br><span class="line">    HH (a, b, c, d, block[ <span class="number">5</span>], s31, <span class="number">0xfffa3942</span>);</span><br><span class="line">    HH (d, a, b, c, block[ <span class="number">8</span>], s32, <span class="number">0x8771f681</span>);</span><br><span class="line">    HH (c, d, a, b, block[<span class="number">11</span>], s33, <span class="number">0x6d9d6122</span>);</span><br><span class="line">    HH (b, c, d, a, block[<span class="number">14</span>], s34, <span class="number">0xfde5380c</span>);</span><br><span class="line">    HH (a, b, c, d, block[ <span class="number">1</span>], s31, <span class="number">0xa4beea44</span>);</span><br><span class="line">    HH (d, a, b, c, block[ <span class="number">4</span>], s32, <span class="number">0x4bdecfa9</span>);</span><br><span class="line">    HH (c, d, a, b, block[ <span class="number">7</span>], s33, <span class="number">0xf6bb4b60</span>);</span><br><span class="line">    HH (b, c, d, a, block[<span class="number">10</span>], s34, <span class="number">0xbebfbc70</span>);</span><br><span class="line">    HH (a, b, c, d, block[<span class="number">13</span>], s31, <span class="number">0x289b7ec6</span>);</span><br><span class="line">    HH (d, a, b, c, block[ <span class="number">0</span>], s32, <span class="number">0xeaa127fa</span>);</span><br><span class="line">    HH (c, d, a, b, block[ <span class="number">3</span>], s33, <span class="number">0xd4ef3085</span>);</span><br><span class="line">    HH (b, c, d, a, block[ <span class="number">6</span>], s34,  <span class="number">0x4881d05</span>);</span><br><span class="line">    HH (a, b, c, d, block[ <span class="number">9</span>], s31, <span class="number">0xd9d4d039</span>);</span><br><span class="line">    HH (d, a, b, c, block[<span class="number">12</span>], s32, <span class="number">0xe6db99e5</span>);</span><br><span class="line">    HH (c, d, a, b, block[<span class="number">15</span>], s33, <span class="number">0x1fa27cf8</span>);</span><br><span class="line">    HH (b, c, d, a, block[ <span class="number">2</span>], s34, <span class="number">0xc4ac5665</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Round 4 */</span></span><br><span class="line">    II (a, b, c, d, block[ <span class="number">0</span>], s41, <span class="number">0xf4292244</span>);</span><br><span class="line">    II (d, a, b, c, block[ <span class="number">7</span>], s42, <span class="number">0x432aff97</span>);</span><br><span class="line">    II (c, d, a, b, block[<span class="number">14</span>], s43, <span class="number">0xab9423a7</span>);</span><br><span class="line">    II (b, c, d, a, block[ <span class="number">5</span>], s44, <span class="number">0xfc93a039</span>);</span><br><span class="line">    II (a, b, c, d, block[<span class="number">12</span>], s41, <span class="number">0x655b59c3</span>);</span><br><span class="line">    II (d, a, b, c, block[ <span class="number">3</span>], s42, <span class="number">0x8f0ccc92</span>);</span><br><span class="line">    II (c, d, a, b, block[<span class="number">10</span>], s43, <span class="number">0xffeff47d</span>);</span><br><span class="line">    II (b, c, d, a, block[ <span class="number">1</span>], s44, <span class="number">0x85845dd1</span>);</span><br><span class="line">    II (a, b, c, d, block[ <span class="number">8</span>], s41, <span class="number">0x6fa87e4f</span>);</span><br><span class="line">    II (d, a, b, c, block[<span class="number">15</span>], s42, <span class="number">0xfe2ce6e0</span>);</span><br><span class="line">    II (c, d, a, b, block[ <span class="number">6</span>], s43, <span class="number">0xa3014314</span>);</span><br><span class="line">    II (b, c, d, a, block[<span class="number">13</span>], s44, <span class="number">0x4e0811a1</span>);</span><br><span class="line">    II (a, b, c, d, block[ <span class="number">4</span>], s41, <span class="number">0xf7537e82</span>);</span><br><span class="line">    II (d, a, b, c, block[<span class="number">11</span>], s42, <span class="number">0xbd3af235</span>);</span><br><span class="line">    II (c, d, a, b, block[ <span class="number">2</span>], s43, <span class="number">0x2ad7d2bb</span>);</span><br><span class="line">    II (b, c, d, a, block[ <span class="number">9</span>], s44, <span class="number">0xeb86d391</span>);</span><br><span class="line">    </span><br><span class="line">    _state[<span class="number">0</span>] += a;</span><br><span class="line">    _state[<span class="number">1</span>] += b;</span><br><span class="line">    _state[<span class="number">2</span>] += c;</span><br><span class="line">    _state[<span class="number">3</span>] += d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Step-4-合并链接变量"><a href="#Step-4-合并链接变量" class="headerlink" title="Step 4. 合并链接变量"></a>Step 4. 合并链接变量</h3><p>就是16进制的转换，比较简单。</p>
<p>不过要注意的是，MD5 是小端算法，所以我们最后得到的结果要倒过来。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> MD5::_toHex(<span class="keyword">const</span> bit32 number) &#123;</span><br><span class="line">    <span class="built_in">stringstream</span> ss;</span><br><span class="line">    ss &lt;&lt; hex &lt;&lt; number;</span><br><span class="line">    <span class="comment">// 小端 反转</span></span><br><span class="line">    <span class="built_in">string</span> result = <span class="string">""</span>;</span><br><span class="line">    result = ss.str().substr(<span class="number">6</span>, <span class="number">2</span>) + ss.str().substr(<span class="number">4</span>, <span class="number">2</span>) + ss.str().substr(<span class="number">2</span>, <span class="number">2</span>) + ss.str().substr(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Step-5-得到答案"><a href="#Step-5-得到答案" class="headerlink" title="Step 5. 得到答案"></a>Step 5. 得到答案</h3><p>将得到新的四个链接变量值变成16进制加起来，就是我们的结果啦！</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> MD5::getResult() &#123;</span><br><span class="line">    _result += _toHex(_state[<span class="number">0</span>]);</span><br><span class="line">    _result += _toHex(_state[<span class="number">1</span>]);</span><br><span class="line">    _result += _toHex(_state[<span class="number">2</span>]);</span><br><span class="line">    _result += _toHex(_state[<span class="number">3</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RUN TEST!</span><br><span class="line">TEST &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;----------</span><br><span class="line">MD5 ("") = d41d8cd9f08204be9800998ecf8427e</span><br><span class="line">MD5 ("a") = 0cc175b9c0f1b6a831c399e269772661</span><br><span class="line">MD5 ("abc") = 900150983cd24fb0d6963f7d28e17f72</span><br><span class="line">MD5 ("hello world") = 5eb63bbbe01eeed093cb22bb8f5acdc3</span><br><span class="line">MD5 ("abcdefghijklmnopqrstuvwxyz") = c3fcd3d76192e47dfb496cca67e13b</span><br><span class="line">MD5 ("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789") = d174ab98d277d9f5a5611c2c9f419d9f</span><br><span class="line">MD5 ("12345678901234567890123456789012345678901234567890123456789012345678901234567890") = 57edf4a22be3c955ac49da2e2107b67a</span><br><span class="line">Program ended with exit code: 0</span><br></pre></td></tr></table></figure>
<p></p></div><div class="share"><span>分享到</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=http://zophyr.com/2018/12/01/hello-md5/%20迷楼%20MD5 算法的设计与实现" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2018/12/04/how-to-own-a-pypi/" title="创建并发布一个 python 包"><i class="fa fa-angle-double-left"></i>&nbsp;上一篇: 创建并发布一个 python 包</a></span><span> / </span><span class="next pagbuttons"><a role="navigation" href="/2018/11/24/huffman-coding/" title="哈夫曼编码及动态编码初相识">下一篇: 哈夫曼编码及动态编码初相识&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2019&nbsp;<a target="_blank" href="http://zophyr.com" rel="noopener noreferrer">Zephyr</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>